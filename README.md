# CRM Leads Service

Backend-сервіс для управління лідами з AI-аналізом через Claude API.

**Стек:** Python 3.12 · FastAPI · PostgreSQL · SQLAlchemy (async) · Alembic · Anthropic Claude · Docker Compose


## Швидкий старт

```bash
git clone <repo>
cd crm-leads

cp .env.example .env
# Вставте ваш ANTHROPIC_API_KEY у .env

docker compose up --build
```

Сервіс доступний на `http://localhost:8000`  
Документація API: `http://localhost:8000/docs`


## Як працює система

### Стадії ліда (холодна обробка)

```
new → contacted → qualified → transferred
                            ↘ lost (з будь-якої стадії)
```

- Не можна пропускати стадії
- `transferred` не можна змінити
- Передача в продажі — окрема дія,а не просто зміна стадії

### Стадії продажу

```
new → kyc → agreement → paid
                       ↘ lost (з будь-якої стадії)
```

- `paid` не можна змінити

### Флоу для менеджера

1. Новий лід → `POST /leads`
2. Оновити кількість комунікацій → `PATCH /leads/{id}/messages`
3. Зміна стадії ліда → `PATCH /leads/{id}/stage`
4. Запустити AI-аналіз → `POST /leads/{id}/analyze`
5. Переглянути рекомендацію AI
6. Передати в продажі `POST /leads/{id}/transfer`
7. Зміна стадії продажу → `PATCH /sales/{id}/stage`


## Де і чому використовується AI

AI-аналіз — це інструмент підтримки рішень менеджера, а не автоматичне рішення.
Менеджер може переоцінити "теплих" лідів і недооцінити "холодних". AI дає незалежну оцінку на основі запиту.
Викликається АІ-аналіз тільки явно: `POST /leads/{id}/analyze`. AI не викликається автоматично при жодній дії — менеджер сам вирішує, коли аналізувати.


## Які дані отримує AI

Система передає Claude :
| Поле | Тип | Навіщо |
|------|-----|--------|
| `source` | enum | Джерело клієнта(партнерські ліди зазвичай якісніші)|
| `stage` | enum | Поточна стадія клієнта |
| `messages_count` | int | Кількість комунікацій(Активність = зацікавленість) |
| `has_business_domain` | bool | Наявність бізнес-домену(неважливо який саме)|

**Що не передається в AI:**
- ID ліда (не потрібен для оцінки)
- Дати (щоб уникнути bias по часу)
- Попередні AI-оцінки (щоб кожен аналіз був незалежним)

### Що повертає AI

```json
{
  "score": 0.78,
  "recommendation": "transfer_to_sales",
  "reason": "lead has high activity and clear business domain"
}
```

Результат зберігається в БД (`ai_score`, `ai_recommendation`, `ai_reason`, `ai_analyzed_at`).

### Як AI обмежений

1. AI не може самостійно перевести ліда в продажі
2. AI не змінює жодних даних — тільки score і recommendation
3. Система перевіряє бізнес-умови незалежно від AI-рекомендації: навіть якщо AI рекомендує `transfer_to_sales`, але score < 0.6 або немає домену — передача заблокована
4. Якщо AI рекомендує `transfer_to_sales`, але менеджер не згоден — він просто не натискає кнопку


## Які рішення приймає людина

1. Запустити AI-аналіз - вирішує, коли лід готовий
2. Передати в продажі - фінальне рішення завжди за людиною 
3. Просувати стадії - менеджер бачить зацікавленість
4. Поставити бізнес-домен - тільки менеджер знає реальну потребу


## Структура проекту

```
app/
├── api/          # HTTP роутери (тільки валідація вхідних даних і HTTP відповіді)
│   ├── leads.py
│   └── sales.py
├── services/     # Вся бізнес-логіка
│   └── lead_service.py
├── ai/           # Ізольована AI-інтеграція
│   └── claude_service.py
├── models/       # SQLAlchemy ORM моделі
│   └── lead.py
├── schemas/      # Pydantic схеми (вхід/вихід API)
│   └── lead.py
├── db/           # Підключення до БД
│   └── database.py
├── config.py
└── main.py
alembic/          # Міграції БД
```


## Що б я ускладнив у реальному проекті

### 1. Логування AI-взаємодій
Окрема таблиця `ai_analysis_log` — щоб зберігати кожен виклик з вхідними даними, відповіддю та часом виконання. Це дозволяє покращувати промпти.

### 2. Версіонування промптів
Зберігати версію промпту разом з AI-результатом. При зміні промпту можна порівнювати якість оцінок.

### 3. Human-in-the-loop аудит
Після кожного переводу в продажі — збереження хто і коли прийняв рішення

### 4. Feedback loop
Коли угода закрита (paid/lost) — порівнювати фактичний результат з AI-прогнозом. Це дозволяє оцінювати якість прогнозу моделі і відкалібрувати score.

### 5. Авторизація
JWT + ролі: `manager` (базова робота), `senior_manager` (може бачити всіх лідів), `admin` (налаштування системи).

### 7. Webhook-нотифікації
При передачі ліда в продажі — відправляти webhook у Telegram/CRM.
